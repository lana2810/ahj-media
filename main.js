(()=>{"use strict";function e(){return navigator.geolocation?new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition((t=>{const{latitude:n,longitude:a}=t.coords;e(`[${n.toFixed(5)},${a.toFixed(5)}]`)}),(e=>{t(e)}))})):new Promise((e=>e(new Error("your devise does not support geolocation"))))}function t(e){return e.match(/[-,.0-9]/g).join("").split(",")}function n(e,n){let a;switch(e){case"isRequired":a=""===n.trim();break;case"isComma":a=!n.includes(",");break;case"isNumber":const[e,s]=t(n);a=!("number"==typeof+e&&"number"==typeof+s)}return a}const a=document.querySelector(".timeline"),s=document.querySelector("#input-message"),o=document.querySelector(".input-div"),c=document.querySelector(".message-list"),d=document.querySelector(".popup-location"),i=document.querySelector(".popup-permission"),r=document.querySelectorAll(".cancel"),l=document.querySelector(".confirm"),u=document.querySelector(".input-popup"),m=document.querySelector(".span-error"),v=document.querySelector(".fa-microphone"),p=document.querySelector(".fa-camera"),L=document.querySelector(".media-div"),h=document.querySelector(".fa-check"),g=document.querySelector(".fa-times"),y=document.querySelector(".timer");let E,f,$;function q(e,t,n,a){const d=document.createElement("div");d.classList.add("message");const i=document.createElement("div");switch(i.classList.add("date"),i.textContent=function(e){const t=new Date(e),n=t.getFullYear(),a=t.getMonth()>9?t.getMonth():`0${t.getMonth()}`,s=t.getDate()>9?t.getDate():`0${t.getDate()}`;return`${t.getHours()>9?t.getHours():`0${t.getHours()}`}:${t.getMinutes()>9?t.getMinutes():`0${t.getMinutes()}`}   ${s}.${a}.${n}`}(e),d.append(i),a){case"text":const e=document.createElement("div");e.classList.add("message-content"),e.textContent=t,d.append(e);break;case"audio":const n=document.createElement("audio");n.classList.add("media"),n.controls=!0,n.src=URL.createObjectURL(t),d.append(n);break;case"video":const a=document.createElement("video");a.classList.add("media"),a.controls=!0,a.src=URL.createObjectURL(t),d.append(a)}const r=document.createElement("span");r.classList.add("location"),r.textContent=n,d.append(r);const l=document.createElement("i");l.classList.add("fa"),l.classList.add("fa-eye"),d.append(l),c.prepend(d),u.value="",s.value="",f=null,$=null,L.classList.add("hidden"),o.classList.remove("hidden")}s.addEventListener("keydown",(t=>{if(13===t.keyCode){f="text",$=s.value;const t=Date.now();e().then((e=>q(t,$,e,"text"))).catch((()=>d.classList.remove("hidden")))}})),r.forEach((e=>{const t=e.closest(".popup");e.addEventListener("click",(e=>{u.value="",m.textContent="",t.classList.add("hidden"),L.classList.add("hidden"),o.classList.remove("hidden"),f=null,$=null}))})),l.addEventListener("click",(e=>{if(e.preventDefault(),n("isRequired",u.value))return void(m.textContent="Поле должно быть заполнено");if(n("isComma",u.value))return void(m.textContent="Значения должны разделятся запятой");if(n("isNumber",u.value))return void(m.textContent="Значения должны быть числом");const a=Date.now(),[s,o]=t(u.value);q(a,$,`[${s},${o}]`,f),d.classList.add("hidden")})),v.addEventListener("click",(()=>{f="audio",L.classList.remove("hidden"),o.classList.add("hidden")})),p.addEventListener("click",(()=>{f="video",L.classList.remove("hidden"),o.classList.add("hidden")})),h.addEventListener("click",(async()=>{let t,n;switch(f){case"audio":try{t=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){i.classList.remove("hidden")}break;case"video":try{n=document.createElement("video"),n.classList.add("media"),n.setAttribute("muted",!0),a.append(n),t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),n.srcObject=t,n.addEventListener("canplay",(()=>{n.play()}))}catch(e){i.classList.remove("hidden")}}try{const a=new MediaRecorder(t),s=[];a.addEventListener("start",(()=>{let e=0,t=0;E=setInterval((()=>{const n=e>9?`${e}`:`0${e}`,a=t>9?`${t}`:`0${t}`;y.textContent=`${n}:${a}`,t++,60===t&&e++}),1e3)})),a.addEventListener("dataavailable",(e=>{s.push(e.data)})),a.addEventListener("stop",(()=>{clearInterval(E),$=new Blob(s);const t=new Date;e().then((e=>q(t,$,e,f))).catch((()=>d.classList.remove("hidden"))),n&&n.remove()})),a.start(),g.addEventListener("click",(()=>{a.stop(),t.getTracks().forEach((e=>e.stop())),y.textContent=""}))}catch(e){console.log(e)}}))})();